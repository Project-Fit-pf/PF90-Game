<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PF90 Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background: linear-gradient(to bottom, #0d1b6b, #1a237e, #283593, #3949ab, #5c6bc0, #dd95ff);
            color: white;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            text-align: center;
        }

        /* ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º */
        .user-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            font-size: 14px;
        }

        #change-user {
            margin-left: 10px;
            padding: 5px 10px;
            background: #FFD700;
            color: #3949ab;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #change-user:hover {
            background: #FFA500;
            transform: translateY(-2px);
        }

        /* ç”¨æˆ·é€‰æ‹©æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: linear-gradient(135deg, #3949ab, #526fff);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            min-width: 300px;
            border: 2px solid #FFD700;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #FFD700;
            font-size: 24px;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 2px solid #FFD700;
            border-radius: 8px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            text-align: center;
        }

        .modal-content input:focus {
            outline: none;
            border-color: #FFA500;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #confirm-user {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #3949ab;
        }

        #confirm-user:hover {
            background: linear-gradient(135deg, #FFA500, #FF8C00);
            transform: translateY(-2px);
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.3);
            overflow: hidden;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        header {
            margin-bottom: 20px;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            color: #e0e0e0;
        }

        .game-info {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .current-position {
            font-size: 18px;
            margin-bottom: 10px;
            color: #FFD700;
        }

        .current-task {
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            color: white;
        }

        .weight-input-container {
            margin-top: 10px;
            display: none;
        }

        .weight-input {
            padding: 8px 12px;
            border: 2px solid #FFD700;
            border-radius: 8px;
            font-size: 16px;
            width: 120px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .save-weight-btn {
            margin-left: 10px;
            padding: 8px 15px;
            background: #FFD700;
            color: #3949ab;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .save-weight-btn:hover {
            background: #FFA500;
            transform: translateY(-2px);
        }

        .weight-display {
            margin-top: 5px;
            font-size: 14px;
            color: #FFD700;
            font-weight: bold;
        }

        .board-container {
            position: relative;
            width: 100%;
            margin-bottom: 30px;
            max-height: 800px;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .game-board {
            width: 100%;
            min-height: 800px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(12, 1fr);
            gap: 8px;
            padding: 15px;
            position: relative;
        }

        .cell {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            position: relative;
            transition: all 0.3s ease;
            text-align: center;
            padding: 10px;
            min-height: 80px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cell.start {
            background: rgba(57, 73, 171, 0.7);
        }

        .cell.finish {
            background: rgba(255, 69, 0, 0.7);
        }

        .cell.current {
            background: rgba(255, 215, 0, 0.7);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            transform: scale(1.05);
            border: 2px solid #FFD700;
        }

        .cell.completed {
            background: rgba(57, 73, 171, 0.4);
        }

        .cell.week-start {
            background: rgba(82, 111, 255, 0.7);
            border: 2px solid rgba(255, 215, 0, 0.5);
        }

        .cell.completed.week-start {
            background: rgba(82, 111, 255, 0.5);
        }

        .cell-number {
            font-size: 12px;
            margin-bottom: 4px;
            font-weight: bold;
            color: #FFD700;
        }

        .cell-content {
            font-size: 12px;
            line-height: 1.3;
        }

        .cell-weight {
            font-size: 10px;
            color: #FFD700;
            margin-top: 2px;
            font-weight: normal;
        }

        .week-label {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 10px;
            background: rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 2px 6px;
            color: #FFD700;
        }

        .player {
            width: 40px;
            height: 40px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23FFD700" stroke="%23FFA500" stroke-width="3"/><circle cx="35" cy="40" r="5" fill="%233949ab"/><circle cx="65" cy="40" r="5" fill="%233949ab"/><path d="M 30 65 Q 50 80 70 65" stroke="%233949ab" stroke-width="3" fill="none"/></svg>');
            background-size: contain;
            position: absolute;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            transition: all 0.5s ease;
            z-index: 10;
        }

        .controls {
            margin-top: 20px;
            position: sticky;
            bottom: 20px;
            background: rgba(57, 73, 171, 0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            gap: 10px;
            justify-content: center;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .move-button {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #3949ab;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            flex: 1;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid #FFD700;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            flex: 1;
        }

        .move-button:hover {
            background: linear-gradient(135deg, #FFA500, #FF8C00);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 165, 0, 0.4);
        }

        .back-button:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-3px);
        }

        .move-button:active,
        .back-button:active {
            transform: translateY(1px);
        }

        .move-button:disabled,
        .back-button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            border: none;
        }

        .week-indicator {
            margin-top: 15px;
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
        }

        .save-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #3949ab;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            font-weight: bold;
        }

        .save-notification.show {
            opacity: 1;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }

        #reset-button {
            padding: 8px 15px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
            transition: all 0.3s ease;
        }

        #reset-button:hover {
            background: #cc0000;
            transform: translateY(-2px);
        }

        .board-container::-webkit-scrollbar {
            width: 8px;
        }

        .board-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .board-container::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.5);
            border-radius: 4px;
        }

        .board-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 215, 0, 0.7);
        }

        @media (max-width: 768px) {
            .game-board {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(23, 1fr);
                min-height: 1200px;
            }

            .board-container {
                max-height: 600px;
            }

            h1 {
                font-size: 26px;
            }

            .cell {
                min-height: 70px;
            }

            .cell-content {
                font-size: 11px;
            }

            .controls {
                flex-direction: column;
            }

            .logo {
                width: 60px;
                height: 60px;
            }

            .user-info {
                position: relative;
                top: auto;
                left: auto;
                margin-bottom: 15px;
                width: 100%;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .game-board {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(35, 1fr);
                min-height: 1400px;
            }

            .board-container {
                max-height: 500px;
            }

            .cell {
                min-height: 65px;
                padding: 8px;
            }
        }
    </style>
</head>

<body>
    <!-- ç”¨æˆ·é€‰æ‹©ç•Œé¢ -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ¯ æ¬¢è¿ä½¿ç”¨PF90å¥èº«æŒ‘æˆ˜</h3>
            <input type="text" id="username-input" placeholder="è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·å" maxlength="20">
            <div class="modal-buttons">
                <button id="confirm-user">å¼€å§‹æŒ‘æˆ˜</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
        <div class="user-info" style="display: none;">
            <span id="current-user">ç”¨æˆ·: åŠ è½½ä¸­...</span>
            <button id="change-user">åˆ‡æ¢ç”¨æˆ·</button>
        </div>

        <div class="logo-container">
            <div class="logo">
                <img src="logo.png" alt="PF90 Logo">
            </div>
            <header>
                <h1>PF90 Game</h1>
                <p class="subtitle">å®Œæˆ90å¤©å¥èº«æŒ‘æˆ˜ï¼</p>
            </header>
        </div>

        <div class="game-info">
            <div class="current-position">å½“å‰ä½ç½®: <span id="position">1</span>/69</div>
            <div class="current-task" id="current-task">Push Weight ____kg</div>
            <div id="weight-display" class="weight-display"></div>
            <div class="weight-input-container" id="weight-input-container">
                <input type="number" class="weight-input" id="weight-input" placeholder="è¾“å…¥é‡é‡" min="0" max="500">
                <button class="save-weight-btn" id="save-weight-btn">ä¿å­˜é‡é‡</button>
            </div>
            <div class="week-indicator" id="week-indicator">ç¬¬1å‘¨</div>
            <div class="action-buttons">
                <button id="reset-button">é‡ç½®è¿›åº¦</button>
            </div>
        </div>

        <div class="board-container">
            <div class="game-board" id="game-board">
                <!-- æ£‹ç›˜æ ¼å­å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="player" id="player"></div>
        </div>

        <div class="controls">
            <button class="back-button" id="back-button">å›åˆ°ä¸Šä¸€æ ¼</button>
            <button class="move-button" id="move-button">å®Œæˆä»Šæ—¥ä»»åŠ¡</button>
        </div>

        <div class="save-notification" id="save-notification">è¿›åº¦å·²è‡ªåŠ¨ä¿å­˜</div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAFuLXShspM2i1OlP12Drpc-tU0cYZ13F0",
            authDomain: "pf-90-80033.firebaseapp.com",
            projectId: "pf-90-80033",
            storageBucket: "pf-90-80033.firebasestorage.app",
            messagingSenderId: "1632448471",
            appId: "1:1632448471:web:af17ddc170123cfc40a592"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // å°†Firebaseå‡½æ•°æš´éœ²ç»™å…¨å±€ä½œç”¨åŸŸ
        window.firebaseApp = app;
        window.firestore = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseServerTimestamp = serverTimestamp;

        console.log('Firebaseåˆå§‹åŒ–å®Œæˆ');
    </script>
    <script>
        // ç”¨æˆ·ç®¡ç†ç±»
        class UserManager {
            constructor() {
                this.currentUser = null;
            }

            // åˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿ
            async init() {
                await this.loadUser();
                if (!this.currentUser) {
                    await this.showUserModal();
                } else {
                    this.hideUserModal();
                    this.updateUI();
                    // åŠ è½½ç”¨æˆ·æ•°æ®
                    const userData = await this.getUserGameData();
                    if (userData) {
                        return userData;
                    }
                }
                return null;
            }

            // åŠ è½½ç”¨æˆ·ä¿¡æ¯
            async loadUser() {
                const savedUser = localStorage.getItem('pf90-currentUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    return true;
                }
                return false;
            }

            // æ˜¾ç¤ºç”¨æˆ·é€‰æ‹©æ¨¡æ€æ¡†
            async showUserModal() {
                return new Promise((resolve) => {
                    const modal = document.getElementById('user-modal');
                    const input = document.getElementById('username-input');
                    const confirmBtn = document.getElementById('confirm-user');

                    modal.style.display = 'flex';
                    input.focus();

                    const handleConfirm = () => {
                        const userName = input.value.trim() || 'å¥èº«å‹‡å£«';
                        if (userName) {
                            this.createUser(userName);
                            modal.style.display = 'none';
                            this.updateUI();
                            resolve();
                        }
                    };

                    confirmBtn.onclick = handleConfirm;
                    input.onkeypress = (e) => {
                        if (e.key === 'Enter') handleConfirm();
                    };
                });
            }

            // éšè—ç”¨æˆ·æ¨¡æ€æ¡†
            hideUserModal() {
                const modal = document.getElementById('user-modal');
                modal.style.display = 'none';
            }

            // åˆ›å»ºæ–°ç”¨æˆ·
            createUser(userName) {
                this.currentUser = {
                    id: this.generateUserId(),
                    name: userName,
                    createdAt: new Date().toISOString()
                };

                localStorage.setItem('pf90-currentUser', JSON.stringify(this.currentUser));
                this.saveUserToFirebase();
            }

            // ç”Ÿæˆç”¨æˆ·ID
            generateUserId() {
                return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            }

            // æ›´æ–°UIæ˜¾ç¤º
            updateUI() {
                const userElement = document.getElementById('current-user');
                const userInfo = document.querySelector('.user-info');

                if (userElement && this.currentUser) {
                    userElement.textContent = `ç©å®¶: ${this.currentUser.name}`;
                    userInfo.style.display = 'block';
                }
            }

            // åˆ‡æ¢ç”¨æˆ·
            async switchUser() {
                if (confirm('ç¡®å®šè¦åˆ‡æ¢ç”¨æˆ·å—ï¼Ÿå½“å‰è¿›åº¦å°†ä¼šä¿å­˜ã€‚')) {
                    // å…ˆä¿å­˜å½“å‰è¿›åº¦
                    if (window.currentPosition && window.weights) {
                        await window.saveGameState();
                    }

                    // æ¸…é™¤ç”¨æˆ·æ•°æ®
                    localStorage.removeItem('pf90-currentUser');
                    localStorage.removeItem('pf90-game-state');
                    this.currentUser = null;

                    // é‡æ–°æ˜¾ç¤ºç”¨æˆ·é€‰æ‹©
                    await this.showUserModal();

                    // é‡æ–°åŠ è½½é¡µé¢
                    location.reload();
                }
            }

            // ä¿å­˜ç”¨æˆ·æ•°æ®åˆ°Firebase
            async saveUserToFirebase() {
                if (!this.currentUser) return;

                const userData = {
                    ...this.currentUser,
                    lastActive: new Date().toISOString(),
                    userAgent: navigator.userAgent
                };

                try {
                    // ä½¿ç”¨ç”¨æˆ·åä½œä¸ºæ–‡æ¡£IDï¼Œä¾¿äºæŸ¥çœ‹
                    await window.firebaseSetDoc(
                        window.firebaseDoc(window.firestore, 'users', this.currentUser.name),
                        userData,
                        { merge: true }
                    );
                    console.log('ç”¨æˆ·æ•°æ®ä¿å­˜åˆ°FirebaseæˆåŠŸ');
                } catch (error) {
                    console.error('ä¿å­˜ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                }
            }

            // è·å–ç”¨æˆ·æ¸¸æˆæ•°æ®
            async getUserGameData() {
                if (!this.currentUser) return null;

                try {
                    // ä½¿ç”¨ç”¨æˆ·åä½œä¸ºæ–‡æ¡£IDæ¥æŸ¥æ‰¾
                    const docRef = window.firebaseDoc(window.firestore, 'userProgress', this.currentUser.name);
                    const docSnap = await window.firebaseGetDoc(docRef);
                    return docSnap.exists() ? docSnap.data() : null;
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                    return null;
                }
            }

            // ä¿å­˜æ¸¸æˆæ•°æ®åˆ°Firebase
            async saveGameData(gameState) {
                if (!this.currentUser) return;

                const gameData = {
                    userId: this.currentUser.id,
                    userName: this.currentUser.name,
                    ...gameState,
                    updatedAt: window.firebaseServerTimestamp()
                };

                try {
                    // ä½¿ç”¨ç”¨æˆ·åä½œä¸ºæ–‡æ¡£ID
                    await window.firebaseSetDoc(
                        window.firebaseDoc(window.firestore, 'userProgress', this.currentUser.name),
                        gameData,
                        { merge: true }
                    );
                    console.log('æ¸¸æˆæ•°æ®ä¿å­˜åˆ°FirebaseæˆåŠŸ');
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜æ¸¸æˆæ•°æ®å¤±è´¥:', error);
                    return false;
                }
            }
            // è·å–å½“å‰ç”¨æˆ·
            getCurrentUser() {
                return this.currentUser;
            }
        }

        // åˆ›å»ºç”¨æˆ·ç®¡ç†å™¨å®ä¾‹
        const userManager = new UserManager();

        document.addEventListener('DOMContentLoaded', async function () {
            // æ¸¸æˆé…ç½®
            const totalCells = 69;

            // å®šä¹‰æ¯å‘¨çš„è®­ç»ƒå†…å®¹
            const weeklyTasks = [
                "Push Weight",
                "Cardio 45mins",
                "Pull",
                "Cardio 45mins",
                "Leg",
                "Cardio 45mins"
            ];

            // ç¬¬5å‘¨å¼€å§‹Cardioå˜ä¸º50åˆ†é’Ÿ
            const weeklyTasksWeek5 = [
                "Push Weight",
                "Cardio 50mins",
                "Pull",
                "Cardio 50mins",
                "Leg",
                "Cardio 50mins"
            ];

            // ç¬¬12å‘¨æœ€åä¸‰å¤©çš„è®­ç»ƒå†…å®¹
            const week12Tasks = [
                "Push 50mins",
                "Pull 50mins",
                "Leg 50mins"
            ];

            // æ¸¸æˆçŠ¶æ€
            let currentPosition = 1;
            let gameOver = false;
            let weights = {};

            // åˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿå¹¶è·å–ç”¨æˆ·æ•°æ®
            const userData = await userManager.init();

            // è®¾ç½®åˆ‡æ¢ç”¨æˆ·æŒ‰é’®äº‹ä»¶
            document.getElementById('change-user').addEventListener('click', function () {
                userManager.switchUser();
            });

            // åˆå§‹åŒ–æ¸¸æˆ
            await initGame(userData);

            // ä¸ºç§»åŠ¨æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
            document.getElementById('move-button').addEventListener('click', function () {
                if (!gameOver) {
                    movePlayer();
                }
            });

            // å›åˆ°ä¸Šä¸€æ ¼æŒ‰é’®äº‹ä»¶
            document.getElementById('back-button').addEventListener('click', function () {
                if (currentPosition > 1) {
                    moveBack();
                }
            });

            // é‡ç½®æŒ‰é’®äº‹ä»¶
            document.getElementById('reset-button').addEventListener('click', function () {
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¿›åº¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                    resetGame();
                }
            });

            // ä¿å­˜é‡é‡æŒ‰é’®äº‹ä»¶
            document.getElementById('save-weight-btn').addEventListener('click', function () {
                saveWeight();
            });

            // è¾“å…¥æ¡†å›è½¦é”®äº‹ä»¶
            document.getElementById('weight-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    saveWeight();
                }
            });

            // åˆå§‹åŒ–æ¸¸æˆ
            async function initGame(userData = null) {
                // å¦‚æœæœ‰ç”¨æˆ·æ•°æ®ï¼Œä½¿ç”¨ç”¨æˆ·æ•°æ®
                if (userData) {
                    currentPosition = userData.currentPosition || 1;
                    weights = userData.weights || {};
                    gameOver = currentPosition >= totalCells;
                } else {
                    // å¦åˆ™ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ•°æ®
                    let gameState = JSON.parse(localStorage.getItem('pf90-game-state')) || {
                        currentPosition: 1,
                        gameOver: false,
                        weights: {}
                    };

                    currentPosition = gameState.currentPosition;
                    gameOver = gameState.gameOver;
                    weights = gameState.weights || {};
                }

                // ç”Ÿæˆæ£‹ç›˜
                generateBoard();

                // æ”¾ç½®ç©å®¶
                placePlayer();

                // æ›´æ–°ä»»åŠ¡æ˜¾ç¤º
                updateTaskDisplay();

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateButtonState();

                // æ›´æ–°é‡é‡æ˜¾ç¤º
                updateWeightDisplay();
            }

            // ä¿å­˜é‡é‡
            async function saveWeight() {
                const weightInput = document.getElementById('weight-input');
                const weight = weightInput.value.trim();

                if (weight === '') {
                    alert('è¯·è¾“å…¥é‡é‡ï¼');
                    return;
                }

                if (parseFloat(weight) <= 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡é‡ï¼');
                    return;
                }

                // ä¿å­˜é‡é‡åˆ°å½“å‰æ ¼å­
                weights[currentPosition] = weight + 'kg';

                // ä¿å­˜æ¸¸æˆçŠ¶æ€
                await saveGameState();

                // æ›´æ–°æ˜¾ç¤º
                updateWeightDisplay();

                // é‡æ–°ç”Ÿæˆæ£‹ç›˜ä»¥æ›´æ–°æ ¼å­å†…å®¹
                generateBoard();
                placePlayer();

                // éšè—è¾“å…¥æ¡†
                document.getElementById('weight-input-container').style.display = 'none';

                // æ¸…ç©ºè¾“å…¥æ¡†
                weightInput.value = '';

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showSaveNotification('é‡é‡å·²ä¿å­˜ï¼');
            }

            // æ›´æ–°é‡é‡æ˜¾ç¤º
            function updateWeightDisplay() {
                const weightDisplay = document.getElementById('weight-display');
                const currentWeight = weights[currentPosition];

                if (currentWeight) {
                    weightDisplay.textContent = `å½“å‰é‡é‡: ${currentWeight}`;
                    weightDisplay.style.display = 'block';
                } else {
                    weightDisplay.style.display = 'none';
                }
            }

            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            async function saveGameState() {
                const gameState = {
                    currentPosition: currentPosition,
                    gameOver: gameOver,
                    weights: weights,
                    startDate: localStorage.getItem('pf90-game-state') ?
                        JSON.parse(localStorage.getItem('pf90-game-state')).startDate :
                        new Date().toISOString(),
                    lastUpdate: new Date().toISOString()
                };

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('pf90-game-state', JSON.stringify(gameState));

                // ä¿å­˜åˆ°Firebase
                const firebaseSuccess = await userManager.saveGameData(gameState);

                // æ˜¾ç¤ºä¿å­˜æç¤º
                if (firebaseSuccess) {
                    showSaveNotification('è¿›åº¦å·²äº‘ç«¯ä¿å­˜');
                } else {
                    showSaveNotification('è¿›åº¦å·²æœ¬åœ°ä¿å­˜');
                }
            }

            // æ˜¾ç¤ºä¿å­˜æç¤º
            function showSaveNotification(message) {
                const notification = document.getElementById('save-notification');
                notification.textContent = message;
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 2000);
            }

            // å›åˆ°ä¸Šä¸€æ ¼
            async function moveBack() {
                if (currentPosition <= 1) return;

                currentPosition--;
                gameOver = false;

                // æ›´æ–°ç©å®¶ä½ç½®
                placePlayer();

                // æ›´æ–°ä»»åŠ¡æ˜¾ç¤º
                updateTaskDisplay();

                // ä¿å­˜æ¸¸æˆçŠ¶æ€
                await saveGameState();

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateButtonState();

                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                const player = document.getElementById('player');
                player.style.transform = 'translateX(-10px)';
                setTimeout(() => {
                    player.style.transform = 'translateX(0)';
                }, 300);
            }

            // é‡ç½®æ¸¸æˆ
            async function resetGame() {
                currentPosition = 1;
                gameOver = false;
                weights = {};
                localStorage.removeItem('pf90-game-state');
                await initGame();
                await saveGameState();
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            function updateButtonState() {
                const moveButton = document.getElementById('move-button');
                const backButton = document.getElementById('back-button');

                if (gameOver) {
                    moveButton.disabled = true;
                    moveButton.textContent = 'æŒ‘æˆ˜å®Œæˆï¼';
                } else {
                    moveButton.disabled = false;
                    moveButton.textContent = 'å®Œæˆä»Šæ—¥ä»»åŠ¡';
                }

                // å›åˆ°ä¸Šä¸€æ ¼æŒ‰é’®çŠ¶æ€
                backButton.disabled = currentPosition <= 1;
            }

            // ç”Ÿæˆæ£‹ç›˜
            function generateBoard() {
                const board = document.getElementById('game-board');
                board.innerHTML = '';

                // æŒ‰å‘¨æ’åˆ—æ£‹ç›˜
                for (let week = 1; week <= 12; week++) {
                    for (let day = 0; day < 6; day++) {
                        const cellNumber = (week - 1) * 6 + day + 1;

                        // åªç”Ÿæˆ1-69çš„æ ¼å­
                        if (cellNumber > totalCells) {
                            // æ·»åŠ ç©ºå•å…ƒæ ¼å ä½
                            const emptyCell = document.createElement('div');
                            emptyCell.style.visibility = 'hidden';
                            board.appendChild(emptyCell);
                            continue;
                        }

                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.id = `cell-${cellNumber}`;

                        // æ·»åŠ å‘¨æ ‡ç­¾
                        if (day === 0) {
                            const weekLabel = document.createElement('div');
                            weekLabel.className = 'week-label';
                            weekLabel.textContent = `W${week}`;
                            cell.appendChild(weekLabel);
                        }

                        // æ·»åŠ æ ¼å­ç¼–å·
                        const cellNumberElement = document.createElement('div');
                        cellNumberElement.className = 'cell-number';
                        cellNumberElement.textContent = cellNumber;
                        cell.appendChild(cellNumberElement);

                        // æ·»åŠ æ ¼å­å†…å®¹
                        const cellContent = document.createElement('div');
                        cellContent.className = 'cell-content';

                        const baseContent = getCellContent(cellNumber);
                        const cellWeight = weights[cellNumber];

                        if (baseContent.includes('Push Weight')) {
                            if (cellWeight) {
                                cellContent.textContent = `Push Weight`;
                                // æ·»åŠ é‡é‡æ˜¾ç¤º
                                const weightElement = document.createElement('div');
                                weightElement.className = 'cell-weight';
                                weightElement.textContent = cellWeight;
                                cell.appendChild(weightElement);
                            } else {
                                cellContent.textContent = `Push Weight ____kg`;
                            }
                        } else {
                            cellContent.textContent = baseContent;
                        }

                        cell.appendChild(cellContent);

                        // æ ‡è®°ç‰¹æ®Šæ ¼å­
                        if (cellNumber === 1) {
                            cell.classList.add('start');
                        } else if (cellNumber === totalCells) {
                            cell.classList.add('finish');
                        }

                        // æ ‡è®°æ¯å‘¨ç¬¬ä¸€å¤©
                        if (day === 0) {
                            cell.classList.add('week-start');
                        }

                        board.appendChild(cell);
                    }
                }
            }

            // è·å–æ ¼å­å†…å®¹
            function getCellContent(cellNumber) {
                // è®¡ç®—å½“å‰æ˜¯ç¬¬å‡ å‘¨
                const week = Math.ceil(cellNumber / 6);

                // è®¡ç®—åœ¨å½“å‰å‘¨çš„ç¬¬å‡ å¤©
                const dayInWeek = (cellNumber - 1) % 6;

                // ç¬¬12å‘¨çš„ç‰¹æ®Šå¤„ç†
                if (week === 12) {
                    if (cellNumber <= 66) {
                        // ç¬¬12å‘¨å‰6å¤©ä½¿ç”¨ç¬¬5å‘¨å¼€å§‹çš„è®­ç»ƒå†…å®¹
                        return weeklyTasksWeek5[dayInWeek];
                    } else {
                        // ç¬¬12å‘¨æœ€å3å¤©ä½¿ç”¨ç‰¹æ®Šè®­ç»ƒå†…å®¹
                        return week12Tasks[cellNumber - 67];
                    }
                }

                // ç¬¬5å‘¨åŠä»¥åä½¿ç”¨æ–°çš„è®­ç»ƒå†…å®¹
                if (week >= 5) {
                    return weeklyTasksWeek5[dayInWeek];
                }

                // å‰4å‘¨ä½¿ç”¨åŸºç¡€è®­ç»ƒå†…å®¹
                return weeklyTasks[dayInWeek];
            }

            // æ”¾ç½®ç©å®¶
            function placePlayer() {
                const player = document.getElementById('player');
                const cell = document.getElementById(`cell-${currentPosition}`);

                // æ¸…é™¤ä¹‹å‰çš„ä½ç½®æ ‡è®°
                document.querySelectorAll('.cell.current').forEach(cell => {
                    cell.classList.remove('current');
                });

                // æ ‡è®°å·²å®Œæˆçš„ä»»åŠ¡
                for (let i = 1; i < currentPosition; i++) {
                    const completedCell = document.getElementById(`cell-${i}`);
                    if (completedCell) {
                        completedCell.classList.add('completed');
                    }
                }

                if (cell) {
                    const cellRect = cell.getBoundingClientRect();
                    const boardRect = document.getElementById('game-board').getBoundingClientRect();

                    player.style.left = `${cellRect.left + cellRect.width / 2 - boardRect.left - 20}px`;
                    player.style.top = `${cellRect.top + cellRect.height / 2 - boardRect.top - 20}px`;

                    // æ ‡è®°å½“å‰ä½ç½®
                    cell.classList.add('current');

                    // è‡ªåŠ¨æ»šåŠ¨åˆ°å½“å‰å•å…ƒæ ¼
                    cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                updatePositionDisplay();
            }

            // ç§»åŠ¨ç©å®¶
            async function movePlayer() {
                if (currentPosition >= totalCells) {
                    gameOver = true;
                    document.getElementById('move-button').disabled = true;
                    document.getElementById('current-task').textContent = "æ­å–œï¼æ‚¨å·²å®ŒæˆPF90æŒ‘æˆ˜ï¼";
                    await saveGameState();
                    return;
                }

                // å‰è¿›ä¸€æ ¼
                currentPosition++;

                // æ›´æ–°ç©å®¶ä½ç½®
                placePlayer();

                // æ·»åŠ è·³è·ƒåŠ¨ç”»
                const player = document.getElementById('player');
                player.style.transform = 'translateY(-15px)';
                setTimeout(() => {
                    player.style.transform = 'translateY(0)';
                }, 250);

                // æ›´æ–°ä»»åŠ¡æ˜¾ç¤º
                updateTaskDisplay();

                // ä¿å­˜æ¸¸æˆçŠ¶æ€
                await saveGameState();

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateButtonState();

                // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç»ˆç‚¹
                if (currentPosition === totalCells) {
                    setTimeout(() => {
                        document.getElementById('current-task').textContent = "æ­å–œï¼æ‚¨å·²å®ŒæˆPF90æŒ‘æˆ˜ï¼";
                        gameOver = true;
                        updateButtonState();
                        saveGameState();
                    }, 600);
                }
            }

            // æ›´æ–°ä½ç½®æ˜¾ç¤º
            function updatePositionDisplay() {
                document.getElementById('position').textContent = currentPosition;

                // æ›´æ–°å‘¨æŒ‡ç¤ºå™¨
                const week = Math.ceil(currentPosition / 6);
                document.getElementById('week-indicator').textContent = `ç¬¬${week}å‘¨`;
            }

            // æ›´æ–°ä»»åŠ¡æ˜¾ç¤º
            function updateTaskDisplay() {
                const currentTask = getCellContent(currentPosition);
                let displayText = currentTask;

                // å¦‚æœæ˜¯Push Weightä»»åŠ¡ä¸”æœ‰é‡é‡è®°å½•
                if (currentTask.includes('Push Weight')) {
                    const currentWeight = weights[currentPosition];
                    if (currentWeight) {
                        displayText = `Push Weight ${currentWeight}`;
                    } else {
                        displayText = 'Push Weight ____kg';
                    }
                }

                document.getElementById('current-task').textContent = displayText;

                // å¦‚æœæ˜¯Push Weightä»»åŠ¡ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
                const weightInputContainer = document.getElementById('weight-input-container');
                if (currentTask.includes('Push Weight') && !weights[currentPosition]) {
                    weightInputContainer.style.display = 'block';
                    document.getElementById('weight-input').focus();
                } else {
                    weightInputContainer.style.display = 'none';
                }

                // æ›´æ–°é‡é‡æ˜¾ç¤º
                updateWeightDisplay();
            }
        });
    </script>
</body>

</html>
